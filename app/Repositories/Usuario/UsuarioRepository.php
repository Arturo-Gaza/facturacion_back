<?php

namespace App\Repositories\Usuario;

use App\DTOs\UserProfileDTO;
use App\Interfaces\Usuario\UsuarioRepositoryInterface;
use App\Models\AsignacionCarga\tab_asignacion;
use App\Models\PasswordReset;
use App\Models\PasswordConf;
use App\Models\PasswordEliminar;
use App\Models\PasswordInhabilitar;
use App\Models\User;
use App\Models\UserSistema;
use App\Models\UserEmail;

use App\Models\UserPhone;
use App\Models\UsuarioRol;
use App\Services\EmailService;
use App\Services\TwilioService;
use Carbon\Carbon;
use Exception;
use Illuminate\Http\Request;

use Illuminate\Support\Arr;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Hash;

class UsuarioRepository implements UsuarioRepositoryInterface
{
    protected $emailService;
    protected $twilioService;

    public function __construct(EmailService $emailService, TwilioService $twilioService)
    {
        $this->emailService = $emailService;
        $this->twilioService = $twilioService;
    }


    public function getAll()
    {
        $usuario = User::all();

        return $usuario;
    }

    public function getCompras()
    {
        return User::where('idRol', 3)->get();
    }

    public function getAllUserAlmacen($idCarga)
    {
        $usuario = User::select(
            'id',
            'user',
            'name',
            'apellidoP',
            'apellidoM',
            'email',
            'idRol',
            'habilitado',
        )
            ->where('idRol', 2)->get();

        $data1 = array();
        foreach ($usuario as $val) {
            $data1[] = $val;
        }

        $usuarioAsigndo = User::select(
            'users.id',
            'users.user',
            'users.name',
            'users.apellidoP',
            'users.apellidoM',
            'users.email',
            'users.idRol',
            'users.habilitado',
            'tab_asignacions.habilitado AS asigHabilitado',
        )
            ->join('tab_asignacions', 'tab_asignacions.id_usuario', '=', 'users.id')
            ->orWhere('tab_asignacions.id_carga', '=', $idCarga)
            ->groupBy('users.id')
            ->groupBy('tab_asignacions.habilitado')
            ->get()->filter(function ($user) {
                return $user->asigHabilitado == 1 && $user->idRol == 2;
            });

        $data2 = array();
        foreach ($usuarioAsigndo as $val) {
            $data2[] = $val;
        }

        $idsData2 = array_column($data2, 'id');
        $resultadoArr = array_diff($data1, array_filter($data1, function ($item) use ($idsData2) {
            return in_array($item['id'], $idsData2);
        }));

        $results = array();
        foreach ($resultadoArr as $val) {
            $results[] = $val;
        }
        return $results;

        //POR SI SE OCUPA EN OTRO LADO
        // $usuario = User::select(
        //     'users.id',
        //     'users.user',
        //     'users.name',
        //     'users.apellidoP',
        //     'users.apellidoM',
        //     'users.email',
        //     'users.idRol',
        //     'users.habilitado',
        //     'tab_asignacions.habilitado AS habilitadoTabAsig',
        //     'tab_asignacions.id_carga'
        // )
        //     ->leftJoin('tab_asignacions', 'tab_asignacions.id_usuario', '=', 'users.id')
        //     ->where(function ($query) use ($idCarga) {
        //         $query->where('tab_asignacions.id_usuario', null)
        //             ->orWhere('tab_asignacions.habilitado', 0)
        //             ->orWhere('tab_asignacions.id_carga', '!=', $idCarga);
        //     })
        //     ->groupBy('users.id')
        //     ->groupBy('tab_asignacions.habilitado')
        //     ->groupBy('tab_asignacions.id_carga')
        //     ->get()->filter(function ($user) {
        //         return $user->idRol == 2;
        //     });

        // $results = array();
        // foreach ($usuario as $val) {
        //     $results[] = $val;
        // }

        // return $results;
    }

    public function getAllUser()
    {
        $usuario = User::select(
            'id',
            'user',
            'name',
            'apellidoP',
            'apellidoM',
            'email',
            'idRol',
            'habilitado',
        )
            ->where('idRol', 2)->get();

        $data1 = array();
        foreach ($usuario as $val) {
            $data1[] = $val;
        }


        return $data1;
    }

    public function getColaboradores($id)
    {
        $users = User::with(['datosFiscalesPrincipal', 'rol', 'departamento', 'mailPrincipal', 'telefonoPrincipal'])
            ->where('usuario_padre', $id)
            ->get();
        // Crear array de DTOs
        $dtos = $users->map(function ($user) use ($id) {
            return UserProfileDTO::fromUserModel($user);
        })->toArray();

        // Devolver el array de DTOs
        return $dtos;
    }

    public function getAllUserAsignado($idCarga)
    {
        $usuario = User::select(
            'users.id',
            'users.user',
            'users.name',
            'users.apellidoP',
            'users.apellidoM',
            'users.email',
            'users.idRol',
            'users.habilitado',
            'tab_asignacions.habilitado AS asigHabilitado',
            'tab_asignacions.id_estatus'
        )
            ->join('tab_asignacions', 'tab_asignacions.id_usuario', '=', 'users.id')
            ->orWhere('tab_asignacions.id_carga', '=', $idCarga)
            ->groupBy('users.id')
            ->groupBy('tab_asignacions.habilitado')
            ->groupBy('tab_asignacions.id_estatus')
            ->get()->filter(function ($user) {
                return $user->asigHabilitado == 1 && $user->idRol == 2;
            });

        $results = array();
        foreach ($usuario as $val) {
            $results[] = $val;
        }

        return $results;
    }


    public function getByID($id): ?User
    {
        return User::where('id', $id)->first();
    }
    public function getDatos($id): ?UserProfileDTO
    {
        $usr = User::where('id', $id)->first();
        return UserProfileDTO::fromUserModel($usr);
    }

    public function editarDatos($request, $id)
    {
        DB::beginTransaction();
        $user = User::with(['datosFiscalesPersonal.domicilioPersonal'])
            ->where('id', $id)
            ->firstOrFail();
        $datosFiscales = $user->datosFiscalesPersonal;
        $direccionActual = $datosFiscales->domicilioPersonal;
        $datosFiscalesData = [
            'nombre_razon' => $request->nombre ?? null,
            'primer_apellido' => $request->primer_apellido ?? null,
            'segundo_apellido' => $request->segundo_apellido ?? null,
        ];
        $direccon = $request->direccionPersonal;
        $direccionDataCompleta = [
            'calle' => $direccon["calle"] ?? null,
            'num_exterior' => $direccon["num_exterior"] ?? null,
            'num_interior' => $direccon["num_interior"] ?? null,
            'colonia' => $direccon["colonia"] ?? null,
            'localidad' => $direccon["localidad"] ?? null,
            'municipio' => $direccon["municipio"] ?? null,
            'estado' => $direccon["estado"] ?? null,
            'codigo_postal' => $direccon["codigo_postal"] ?? null
        ];
        if ($datosFiscales) {
            $datosFiscales->update($datosFiscalesData);
        }
        if ($direccionActual) {
            $direccionActual->update($direccionDataCompleta);
        }

        DB::commit();
        $user = User::where('id', $id)
            ->firstOrFail();;
        $user->load(['datosFiscalesPrincipal', 'rol', 'departamento', 'mailPrincipal', 'telefonoPrincipal']);

        return UserProfileDTO::fromUserModel($user);
    }

    public function getAllHabilitados()
    {
        return User::where('habilitado', 1)->get();
    }
    public function enviarCorreoRec($data)
    {
        $usr = $this->findByEmailOrUser($data['email']);
        if (!$usr)
            return null;
        $email = $usr->email;

        $usr = $this->emailService->enviarCorreoRec($email);
        return $usr;
    }

    public function enviarCorreoConf($data)
    {
        $usr = $this->findByEmailOrUser($data['email']);
        if (!$usr)
            return null;
        $email = $usr->email;

        $usr = $this->emailService->enviarCorreoConf($email);
        return $usr;
    }

    public function enviarCorreoInhabilitar($data)
    {
        $usr = $this->findByEmailOrUser($data['email']);
        if (!$usr)
            return null;
        $email = $usr->email;

        $usr = $this->emailService->enviarCorreoInhabilitar($email);
        return $usr;
    }

    public function enviarCorreoEliminar($data)
    {
        $usr = $this->findByEmailOrUser($data['email']);
        if (!$usr)
            return null;
        $email = $usr->email;

        $usr = $this->emailService->enviarCorreoEliminar($email);
        return $usr;
    }

    public function enviarSMSConf($data)
    {
        $usr = $this->findByEmailOrUser($data['phone']);
        if (!$usr)
            return null;
        $phone = $usr->phone;

        $usr = $this->twilioService->sendSMSConf($phone);
        return $usr;
    }

    public function recPass($data)
    {
        $codigo = $data['codigo'];
        $usr = $this->findByEmailOrUser($data['email']);
        if (!$usr)
            return null;
        $email = $usr->email;
        $nuevaPass = Hash::make($data['nuevaPass']);

        $passwordReset = PasswordReset::where('email', $email)
            ->where('used', false)
            ->get();

        foreach ($passwordReset as $reset) {
            if (Hash::check($codigo, $reset->codigo)) {
                // Verificar si el cÃ³digo ha expirado


                // Si quieres marcarlo como usado aquÃ­
                $reset->used = true;
                $reset->used_at = now();
                $reset->save();

                //  $usr = User::where('email', $email)->first();
                $usr->password = $nuevaPass;
                $usr->save();
                return "ContraseÃ±a cambiada con exito";
            }
        }


        return "Error inesperado";
    }

    public function desHabilitar($data)
    {
        $codigo = $data['codigo'];
        $usr = $this->findByEmailOrUser($data['email']);
        if (!$usr)
            return null;
        $email = $usr->email;

        $passwordReset = PasswordInhabilitar::where('email', $email)
            ->where('used', false)
            ->get();

        foreach ($passwordReset as $reset) {
            if (Hash::check($codigo, $reset->codigo)) {
                // Verificar si el cÃ³digo ha expirado


                // Si quieres marcarlo como usado aquÃ­
                $reset->used = true;
                $reset->used_at = now();
                $reset->save();

                //  $usr = User::where('email', $email)->first();
                $usr->id_estatus_usuario = 2;
                $usr->save();
                return "Usuario inhabilitado correctamente";
            }
        }


        throw new Exception('Error inesperado', 409);
    }
    public function eliminar($data)
    {
        $codigo = $data['codigo'];
        $usr = $this->findByEmailOrUser($data['email']);
        if (!$usr)
            return null;
        $email = $usr->email;

        $passwordReset = PasswordEliminar::where('email', $email)
            ->where('used', false)
            ->get();

        foreach ($passwordReset as $reset) {
            if (Hash::check($codigo, $reset->codigo)) {
                // Verificar si el cÃ³digo ha expirado
                // Si quieres marcarlo como usado aquÃ­
                $reset->used = true;
                $reset->used_at = now();
                $reset->save();

                //  $usr = User::where('email', $email)->first();
                $usr->id_estatus_usuario = 3;
                $usr->save();
                return "Usuario eliminado correctamente";
            }
        }


        throw new Exception('Error inesperado', 409);
    }


    public function validarCorreoRec($data)
    {
        $codigo = $data['codigo'];
        $usr = $this->findByEmailOrUser($data['email']);
        if (!$usr)
            return null;
        $email = $usr->email;
        $expiraEnMinutos = 10;
        $passwordReset = PasswordReset::where('email', $email)
            ->where('used', false)
            ->get();

        foreach ($passwordReset as $reset) {
            if (Hash::check($codigo, $reset->codigo)) {
                // Verificar si el cÃ³digo ha expirado
                if (Carbon::parse($reset->created_at)->addMinutes($expiraEnMinutos)->isPast()) {
                    return null;
                }


                return "CÃ³digo vÃ¡lido";
            }
        }
        // Continuar con el flujo para permitir cambiar contraseÃ±a
    }

    public function validarCorreoConf($data)
    {
        DB::beginTransaction();
        $codigo = $data['codigo'];
        $usr = $this->findByEmailOrUser($data['email']);
        if (!$usr) {
            DB::rollBack();
            return null;
        }
        $email = $usr->email;
        $expiraEnMinutos = 10;
        $passwordReset = PasswordConf::where('email', $email)
            ->where('used', false)
            ->get();

        foreach ($passwordReset as $reset) {
            if (Hash::check($codigo, $reset->codigo)) {
                // Verificar si el cÃ³digo ha expirado
                if (Carbon::parse($reset->created_at)->addMinutes($expiraEnMinutos)->isPast()) {
                    DB::rollBack();
                    return null;
                }
                // Actualizar el registro en password_confirm_mail_tokens
                $reset->update([
                    'used' => true,
                    'used_at' => now()
                ]);

                // Actualizar el correo como verificado en user_emails
                UserEmail::where('email', $email)
                    ->update([
                        'verificado' => true
                    ]);

                DB::commit();

                return "CÃ³digo vÃ¡lido";
            }
        }
        DB::rollBack();
        return null;
    }

    public function validarCorreoInhabilitar($data)
    {
        DB::beginTransaction();
        $codigo = $data['codigo'];
        $usr = $this->findByEmailOrUser($data['email']);
        if (!$usr) {
            DB::rollBack();
            return null;
        }
        $email = $usr->email;
        $expiraEnMinutos = 10;
        $passwordReset = PasswordInhabilitar::where('email', $email)
            ->where('used', false)
            ->get();

        foreach ($passwordReset as $reset) {
            if (Hash::check($codigo, $reset->codigo)) {
                // Verificar si el cÃ³digo ha expirado
                if (Carbon::parse($reset->created_at)->addMinutes($expiraEnMinutos)->isPast()) {
                    DB::rollBack();
                    return null;
                }

                DB::commit();

                return "CÃ³digo vÃ¡lido";
            }
        }
        DB::rollBack();
        return null;
    }
    public function validarCorreoEliminar($data)
    {
        DB::beginTransaction();
        $codigo = $data['codigo'];
        $usr = $this->findByEmailOrUser($data['email']);
        if (!$usr) {
            DB::rollBack();
            return null;
        }
        $email = $usr->email;
        $expiraEnMinutos = 10;
        $passwordReset = PasswordEliminar::where('email', $email)
            ->where('used', false)
            ->get();

        foreach ($passwordReset as $reset) {
            if (Hash::check($codigo, $reset->codigo)) {
                // Verificar si el cÃ³digo ha expirado
                if (Carbon::parse($reset->created_at)->addMinutes($expiraEnMinutos)->isPast()) {
                    DB::rollBack();
                    return null;
                }

                DB::commit();

                return "CÃ³digo vÃ¡lido";
            }
        }
        DB::rollBack();
        return null;
    }

    public function findByEmailOrUser(string $email): ?User
    {
        return User::where('id_estatus_usuario', 1)
            ->where(function ($query) use ($email) {
                $query->whereHas('mailPrincipal', function ($q) use ($email) {
                    $q->where('email', $email);
                })->orWhereHas('telefonoPrincipal', function ($q) use ($email) {
                    $q->where('telefono', $email);
                });
            })
            ->first();
    }

    public function responseUser(string $email)
    {
        return User::whereHas('mailPrincipal', function ($query) use ($email) {
            $query->where('email', $email);
        })
            ->first();
    }

    public function store(array $data)
    {
        $data['password'] = Hash::make($data['password']);
        return User::create($data);
    }

    public function storeCliente(array $data)
    {
        $email = $data['email'];
        $tel   = $data['tel'];

        // 1. Buscar email existente
        $existingEmail = UserEmail::where('email', $email)->first();
        if ($existingEmail) {
            if ($existingEmail->verificado) {
                throw new \Exception('Usuario existente ', 409);
            } else {
                // Eliminar usuario completo (esto eliminarÃ¡ en cascada emails y telÃ©fonos)
                $userToDelete = User::where('id_mail_principal', $existingEmail->id)
                    ->orWhereHas('emails', function ($query) use ($email) {
                        $query->where('email', $email);
                    })
                    ->first();

                if ($userToDelete) {
                    $userToDelete->delete(); // Esto eliminarÃ¡ todo en cascada
                } else {
                    $existingEmail->delete();
                }
            }
        }

        // 2. Buscar telÃ©fono existente
        $existingPhone = UserPhone::where('telefono', $tel)->first();
        if ($existingPhone) {
            if ($existingPhone->verificado) {
                throw new \Exception('Usuario existente ', 409);
            } else {
                // Eliminar usuario completo
                $userToDelete = User::where('id_telefono_principal', $existingPhone->id)
                    ->orWhereHas('phones', function ($query) use ($tel) {
                        $query->where('telefono', $tel);
                    })
                    ->first();

                if ($userToDelete) {
                    $userToDelete->delete(); // Esto eliminarÃ¡ todo en cascada
                } else {
                    $existingPhone->delete();
                }
            }
        }

        // 3. Crear nuevo usuario
        $data['password'] = Hash::make($data['password']);
        $user = User::create([
            'password'  => $data['password'],
            'idRol'     => $data['idRol'] ?? 2,
        ]);

        // 4. Guardar correo y telÃ©fono
        $correo = $user->emails()->create([
            'email' => $email,
        ]);

        $telefono = $user->phones()->create([
            'telefono' => $tel,
        ]);

        $user->update([
            'id_mail_principal' => $correo->id,
            'id_telefono_principal' => $telefono->id
        ]);

        return   $user;
    }

    public function storeHijo(array $data)
    {
        $email = $data['email'];
        $idPadre   = $data['id_usuario'];

        // 1. Buscar email existente
        $existingEmail = UserEmail::where('email', $email)->first();
        if ($existingEmail) {
            if ($existingEmail->verificado) {
                throw new \Exception('Usuario existente ', 409);
            } else {
                // Eliminar usuario completo (esto eliminarÃ¡ en cascada emails y telÃ©fonos)
                $userToDelete = User::where('id_mail_principal', $existingEmail->id)
                    ->orWhereHas('emails', function ($query) use ($email) {
                        $query->where('email', $email);
                    })
                    ->first();

                if ($userToDelete) {
                    $userToDelete->delete(); // Esto eliminarÃ¡ todo en cascada
                } else {
                    $existingEmail->delete();
                }
            }
        }

        $password = $this->generarPasswordAvanzado();
        $usr = $this->emailService->enviarCorreoHijo($email, $password);

        // 3. Crear nuevo usuario
        $passwordHash = Hash::make($password);
        $user = User::create([
            'password'  => $passwordHash,
            'idRol'     => $data['idRol'] ?? 3,
            'usuario_padre' => $idPadre,
            'password_temporal' => true
        ]);

        // 4. Guardar correo y telÃ©fono
        $correo = $user->emails()->create([
            'email' => $email,
        ]);



        $user->update([
            'id_mail_principal' => $correo->id
        ]);

        return $user;
    }

    public function completarHijo(array $data)
    {
        $email = $data['email'];
        $tel   = $data['tel'];
        $user= $this->findByEmailOrUser($email);
          $existingPhone = UserPhone::where('telefono', $tel)->first();
        if ($existingPhone) {
            if ($existingPhone->verificado) {
                throw new \Exception('Usuario existente ', 409);
            } else {
                // Eliminar usuario completo
                $userToDelete = User::where('id_telefono_principal', $existingPhone->id)
                    ->orWhereHas('phones', function ($query) use ($tel) {
                        $query->where('telefono', $tel);
                    })
                    ->first();

                if ($userToDelete) {
                    $userToDelete->delete(); // Esto eliminarÃ¡ todo en cascada
                } else {
                    $existingPhone->delete();
                }
            }
        }

        // 3. Crear nuevo usuario
        $data['password'] = Hash::make($data['password']);



        $telefono = $user->phones()->create([
            'telefono' => $tel,
        ]);

        $user->update([
            'password'  => $data['password'],
            'id_telefono_principal' => $telefono->id,
            'password_temporal'=>false
        ]);
        return $user;
    }

    function generarPasswordAvanzado($longitudMin = 15, $longitudMax = 20)
    {
        $longitud = random_int($longitudMin, $longitudMax);

        $caracteres = [
            'mayusculas' => 'ABCDEFGHJKLMNPQRSTUVWXYZ', // EliminÃ© I, O para evitar confusiÃ³n
            'minusculas' => 'abcdefghjkmnpqrstuvwxyz',  // EliminÃ© i, l, o
            'numeros' => '23456789',                    // EliminÃ© 0, 1
            'especiales' => '!@#$%&*+-=?'
        ];

        $password = '';

        // Un carÃ¡cter de cada tipo
        foreach ($caracteres as $tipo => $caracteresTipo) {
            $password .= $caracteresTipo[random_int(0, strlen($caracteresTipo) - 1)];
        }

        // Todos los caracteres combinados
        $todos = implode('', $caracteres);

        // Completar
        for ($i = strlen($password); $i < $longitud; $i++) {
            $password .= $todos[random_int(0, strlen($todos) - 1)];
        }

        // Convertir a array, mezclar y volver a string
        $passwordArray = str_split($password);
        shuffle($passwordArray);

        return implode('', $passwordArray);
    }


    public function update(array $data, $id)
    {
        return User::whereId($id)->update($data);
    }

    public function updatePassword(array $data, $id)
    {
        $data['password'] = Hash::make($data['password']);
        return User::whereId($id)->update($data);
    }


    public function aumentarIntento(int $intentos, $id)
    {
        User::where('id', $id)->update(array('intentos' => $intentos + 1));
    }

    public function generateToken(User $user): string
    {
        $token = $user->createToken('API Token');
        return $token->plainTextToken;
    }

    public function loginActive(int $id)
    {
        User::where('id', $id)->update(array('login_activo' => true));
    }

    public function loginInactive(int $id)
    {
        User::where('id', $id)->update(array('login_activo' => false));
    }

    public function deleteUser(array $data, $id)
    {
        return User::whereId($id)->update($data);
    }

    public function desencriptarAES($textoEncriptado)
    {
        $clave = "mi_clave_super_secreta_123";
        $cifra = "AES-256-CBC";
        $key = hash('sha256', $clave, true); // misma clave que en JS
        $iv = substr($key, 0, 16); // IV derivado de la clave (debe coincidir con JS si no usas uno dinÃ¡mico)

        $textoEncriptado = base64_decode($textoEncriptado);
        return openssl_decrypt($textoEncriptado, $cifra, $key, OPENSSL_RAW_DATA, $iv);
    }
}
